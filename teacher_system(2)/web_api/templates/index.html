<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨è‡ªåŠ¨é«˜æ ¡æ•™å¸ˆä¿¡æ¯ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-color: #2563eb; /* ç§‘æŠ€è“ */
            --primary-hover: #1d4ed8;
            --danger-color: #ef4444;   /* è­¦å‘Šçº¢ */
            --danger-hover: #dc2626;
            --success-color: #10b981;  /* æˆåŠŸç»¿ */
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            background: linear-gradient(135deg, var(--primary-color), #4f46e5);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
        }

        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header p {
            margin-top: 0.5rem;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            transition: transform 0.2s;
            border: 1px solid #e5e7eb;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title.admin { color: var(--danger-color); }
        .card-title.search { color: var(--primary-color); }

        /* è¡¨å•å…ƒç´  */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .form-row input {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-main);
        }

        input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box; /* é‡è¦ï¼šé˜²æ­¢paddingæ’‘ç ´å®½åº¦ */
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* æŒ‰é’® */
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:active { transform: translateY(1px); }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); shadow: var(--shadow-md); }

        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }

        .btn-success { background-color: var(--success-color); color: white; }

        /* çŠ¶æ€æ  */
        .status-box {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none; /* é»˜è®¤éšè— */
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .status-running { background-color: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; display: block; }
        .status-finished { background-color: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; display: block; }
        .status-error { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; display: block; }

        /* æœç´¢ç»“æœç½‘æ ¼å¸ƒå±€ */
        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        /* æ•™å¸ˆå¡ç‰‡ç¾åŒ– */
        .teacher-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .teacher-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .teacher-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary-color);
        }

        .t-name { font-size: 1.2rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.25rem; }
        .t-title { font-size: 0.9rem; color: var(--text-sub); background: #eff6ff; padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 0.8rem;}
        .t-info { font-size: 0.9rem; color: #4b5563; margin-bottom: 0.5rem; }
        .t-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .t-link a:hover { text-decoration: underline; }

        /* Admin åŒºåŸŸæŠ˜å /å±•å¼€ (å¯é€‰è§†è§‰ä¼˜åŒ–) */
        .admin-section {
            border-top: 4px solid var(--danger-color);
        }

        /* æç¤ºæ–‡æœ¬ */
        .hint-text {
            font-size: 0.85rem;
            color: var(--text-sub);
            margin-bottom: 1rem;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>ğŸ“ é«˜æ ¡æ•™å¸ˆä¿¡æ¯å…¨è‡ªåŠ¨ç³»ç»Ÿ</h1>
        <p>åŸºäº AI é©±åŠ¨çš„è‡ªåŠ¨åŒ–æ•°æ®é‡‡é›†ä¸æ£€ç´¢å¼•æ“</p>
    </header>

    <div class="main-container">

        <section class="card">
            <div class="card-title search">
                <span>ğŸ”</span> æ•°æ®æŸ¥è¯¢
            </div>
            <div class="form-row">
                <input type="text" id="nameInput" placeholder="å§“å (ä¾‹å¦‚: å¼ ä¸‰)">
                <input type="text" id="collegeInput" placeholder="å­¦é™¢ (ä¾‹å¦‚: è®¡ç®—æœº)">
                <input type="text" id="researchInput" placeholder="ç ”ç©¶æ–¹å‘ (ä¾‹å¦‚: äººå·¥æ™ºèƒ½)">
            </div>
            <div style="margin-top: 1rem; text-align: right;">
                <button id="searchBtn" class="btn-primary">å¼€å§‹æœç´¢</button>
            </div>

            <div id="results">
                <div style="grid-column: 1/-1; text-align: center; color: #9ca3af; padding: 2rem;">
                    è¯·è¾“å…¥æ¡ä»¶å¹¶ç‚¹å‡»æœç´¢...
                </div>
            </div>
        </section>


        <section class="card admin-section">
            <div class="card-title admin">
                <span>âš™ï¸</span> ç®¡ç†å‘˜æ§åˆ¶å°ï¼šæ•°æ®é‡‡é›†
            </div>
            
            <div style="margin-bottom: 2rem;">
                <label for="masterUrlInput">æ–¹æ¡ˆ A: å…¨æµç¨‹è‡ªåŠ¨åŒ–é‡‡é›† (æ¨è)</label>
                <p class="hint-text">è¾“å…¥å¤§å­¦çš„â€œé™¢ç³»è®¾ç½®â€æ€»è§ˆé¡µé¢ï¼ŒAI å°†è‡ªåŠ¨åˆ†ææ‰€æœ‰å­¦é™¢é“¾æ¥å¹¶æ‰¹é‡æŠ“å–ã€‚</p>
                <div class="form-row">
                    <input type="text" id="masterUrlInput" value="https://www.pku.edu.cn/department.html" placeholder="è¯·è¾“å…¥å¤§å­¦é™¢ç³»å…¥å£ URL">
                    <button id="fullAutomationBtn" class="btn-danger" style="flex: 0 0 auto;">ğŸš€ å¯åŠ¨å…¨è‡ªåŠ¨é‡‡é›†</button>
                </div>
                <div id="fullAutomationStatus" class="status-box"></div>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 2rem 0;">

            <div>
                <label>æ–¹æ¡ˆ B: æ‰‹åŠ¨å•å­¦é™¢é‡‡é›† (å¤‡ç”¨)</label>
                <p class="hint-text">å¦‚æœå…¨è‡ªåŠ¨å¤±è´¥ï¼Œå¯åœ¨æ­¤æ‰‹åŠ¨è¾“å…¥å•ä¸ªå­¦é™¢çš„å¸ˆèµ„åˆ—è¡¨ç½‘å€è¿›è¡Œè¡¥å……ã€‚</p>
                <div class="form-row">
                    <input type="text" id="collegeInputManual" placeholder="å­¦é™¢åç§° (å¦‚: åŒ–å­¦ç³»)">
                    <input type="text" id="urlInputManual" placeholder="å¸ˆèµ„åˆ—è¡¨ç½‘å€ (URL)">
                    <button id="generateBtn" class="btn-primary" style="background-color: #4b5563;">ğŸ¤– ç”Ÿæˆé…æ–¹å¹¶é‡‡é›†</button>
                </div>
                <div id="status" class="status-box"></div>
            </div>
        </section>

    </div>

    <script>
        let jobPoller = null; 

        // --- æ£€æŸ¥åå°ä»»åŠ¡çŠ¶æ€ ---
        async function checkJobStatus() {
            let statusEl = document.getElementById('fullAutomationStatus');
            try {
                let response = await fetch('/api/check-status');
                let result = await response.json();

                statusEl.innerHTML = ''; // æ¸…ç©ºå†…å®¹

                // æ·»åŠ åŠ è½½å›¾æ ‡æˆ–çŠ¶æ€å›¾æ ‡
                let icon = '';
                let statusClass = '';

                if (result.status === 'running') {
                    icon = 'â³ ';
                    statusClass = 'status-running';
                    statusEl.textContent = icon + " " + result.message;
                } else if (result.status === 'finished') {
                    icon = 'âœ… ';
                    statusClass = 'status-finished';
                    statusEl.textContent = icon + " " + result.message;
                    clearInterval(jobPoller);
                    alert("ğŸ‰ å…¨æµç¨‹è‡ªåŠ¨åŒ–å·²å®Œæˆï¼æ•°æ®å·²å…¥åº“ï¼Œæ‚¨å¯ä»¥å¼€å§‹æœç´¢äº†ã€‚");
                } else if (result.status === 'error') {
                    icon = 'âŒ ';
                    statusClass = 'status-error';
                    statusEl.textContent = icon + " " + result.message;
                    clearInterval(jobPoller);
                }

                statusEl.className = 'status-box ' + statusClass;

            } catch (error) {
                statusEl.textContent = `âŒ è½®è¯¢å¤±è´¥: ${error.message}`;
                statusEl.className = 'status-box status-error';
                clearInterval(jobPoller);
            }
        }

        // --- å…¨æµç¨‹è‡ªåŠ¨åŒ–æŒ‰é’® ---
        document.getElementById('fullAutomationBtn').addEventListener('click', async () => {
            let statusEl = document.getElementById('fullAutomationStatus');
            let masterUrl = document.getElementById('masterUrlInput').value;
            
            if (!masterUrl) {
                alert("è¯·è¾“å…¥ç½‘å€ï¼");
                return;
            }

            if (!confirm("âš ï¸ é«˜è´Ÿè½½è­¦å‘Š\n\nç¡®å®šè¦å¯åŠ¨å…¨æµç¨‹è‡ªåŠ¨åŒ–å—ï¼Ÿ\nè¿™å°†æ‰«ææ•´ä¸ªç½‘ç«™ï¼Œè€—æ—¶å¯èƒ½è¶…è¿‡ 10 åˆ†é’Ÿã€‚")) {
                return;
            }
            
            statusEl.textContent = 'ğŸš€ æ­£åœ¨å¯åŠ¨å¼•æ“ï¼Œè¯·ç¨å€™...';
            statusEl.className = 'status-box status-running';
            
            try {
                let response = await fetch('/api/start-full-automation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ master_url: masterUrl })
                });
                let result = await response.json();
                
                if (!response.ok) {
                    statusEl.innerHTML = `âŒ å¯åŠ¨å¤±è´¥: ${result.message}`;
                    statusEl.className = 'status-box status-error';
                } else {
                    if (jobPoller) clearInterval(jobPoller);
                    jobPoller = setInterval(checkJobStatus, 3000);
                }
            } catch (error) {
                statusEl.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
                statusEl.className = 'status-box status-error';
            }
        });

        // --- é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€ ---
        document.addEventListener('DOMContentLoaded', () => {
            checkJobStatus();
            let statusEl = document.getElementById('fullAutomationStatus');
            if (statusEl.classList.contains('status-running')) {
                if (jobPoller) clearInterval(jobPoller);
                jobPoller = setInterval(checkJobStatus, 3000);
            }
        });

        // --- æœç´¢åŠŸèƒ½ ---
        document.getElementById('searchBtn').addEventListener('click', async () => {
            let resultsDiv = document.getElementById('results');
            let btn = document.getElementById('searchBtn');
            
            // ç®€å•çš„åŠ è½½åŠ¨ç”»
            btn.textContent = 'æœç´¢ä¸­...';
            btn.disabled = true;
            resultsDiv.innerHTML = '<div style="grid-column:1/-1;text-align:center;">â³ æ­£åœ¨æ£€ç´¢æ•°æ®åº“...</div>';

            let name = document.getElementById('nameInput').value;
            let college = document.getElementById('collegeInput').value;
            let research = document.getElementById('researchInput').value;
            let queryParams = new URLSearchParams();
            if (name) queryParams.append('name', name);
            if (college) queryParams.append('college', college);
            if (research) queryParams.append('research', research);

            try {
                let response = await fetch(`/api/search?${queryParams.toString()}`);
                let result = await response.json();
                
                if(response.ok && result.status === 'success') {
                    if (result.data.length === 0) {
                        resultsDiv.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:#666;">ğŸ“­ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•™å¸ˆä¿¡æ¯ã€‚</div>';
                    } else {
                        resultsDiv.innerHTML = ''; // æ¸…ç©º loading
                        // é¡¶éƒ¨æ˜¾ç¤ºç»“æœæ•°é‡
                        let countInfo = document.createElement('div');
                        countInfo.style.gridColumn = '1/-1';
                        countInfo.style.color = '#6b7280';
                        countInfo.style.marginBottom = '10px';
                        countInfo.innerHTML = `å…±æ‰¾åˆ° <b>${result.data.length}</b> æ¡è®°å½•`;
                        resultsDiv.appendChild(countInfo);

                        result.data.forEach(teacher => {
                            let card = document.createElement('div');
                            card.className = 'teacher-card';
                            card.innerHTML = `
                                <div class="t-name">${teacher.name || 'æœªçŸ¥å§“å'}</div>
                                <div class="t-title">${teacher.title || 'æ•™å¸ˆ'}</div>
                                <div class="t-info">ğŸ« <strong>${teacher.university}</strong> - ${teacher.department || ''}</div>
                                <div class="t-info">ğŸ“§ ${teacher.email || 'æš‚æ— é‚®ç®±'}</div>
                                <div class="t-info">ğŸ”¬ ${teacher.research_interests || 'æ— ç‰¹å®šç ”ç©¶æ–¹å‘'}</div>
                                <div class="t-link" style="margin-top:10px; padding-top:10px; border-top:1px dashed #eee;">
                                    <a href="${teacher.profile_url}" target="_blank">ğŸ”— æŸ¥çœ‹å®˜æ–¹ä¸ªäººä¸»é¡µ</a>
                                </div>
                            `;
                            resultsDiv.appendChild(card);
                        });
                    }
                } else {
                    resultsDiv.innerHTML = `<div style="color:red;">åŠ è½½å¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color:red;">ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            } finally {
                btn.textContent = 'å¼€å§‹æœç´¢';
                btn.disabled = false;
            }
        });

        // --- æ‰‹åŠ¨é‡‡é›† ---
        document.getElementById('generateBtn').addEventListener('click', async () => {
            let statusEl = document.getElementById('status');
            let college = document.getElementById('collegeInputManual').value;
            let url = document.getElementById('urlInputManual').value;
            let btn = document.getElementById('generateBtn');

            if (!college || !url) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å­¦é™¢åç§°å’Œç½‘å€ï¼');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æ­£åœ¨åˆ†æ...';
            statusEl.innerHTML = 'â³ æ­£åœ¨ä¸‹è½½ç½‘é¡µå¹¶è¯·æ±‚ AI ç”Ÿæˆé…æ–¹...';
            statusEl.className = 'status-box status-running';

            try {
                let response = await fetch('/api/generate-recipe', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ college: college, url: url })
                });
                let result = await response.json();
                if (response.ok && result.status === 'success') {
                    statusEl.innerHTML = `
                        <div style="font-weight:bold; margin-bottom:10px;">âœ… ${result.message}</div>
                        <div style="font-size:0.8em; color:#666;">é…æ–¹æ¦‚è§ˆ:</div>
                        <pre>${JSON.stringify(result.recipe, null, 2)}</pre>
                    `;
                    statusEl.className = 'status-box status-finished';
                } else {
                    statusEl.innerHTML = `âŒ ç”Ÿæˆå¤±è´¥: ${result.message}`;
                    statusEl.className = 'status-box status-error';
                }
            } catch (error) {
                statusEl.innerHTML = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
                statusEl.className = 'status-box status-error';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¤– ç”Ÿæˆé…æ–¹å¹¶é‡‡é›†';
            }
        });
    </script>
</body>
</html>